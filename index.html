<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Community Doc</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #eceff1; 
            margin: 0;
        }
        #auth-wrap { 
            text-align: center; 
            margin-top: 15vh; 
        }
        #editor-wrap { 
            display: none; 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        h1 { color: #263238; }
        textarea { 
            width: 100%; 
            height: 70vh; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #cfd8dc; 
            font-size: 16px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            resize: none;
            box-sizing: border-box;
        }
        .controls {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        input, button { 
            padding: 10px 15px; 
            font-size: 16px; 
            border-radius: 4px; 
            border: 1px solid #cfd8dc; 
        }
        button { 
            background: #007bff; 
            color: white; 
            cursor: pointer; 
            border: none; 
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        .btn-download { background: #28a745; }
        .btn-download:hover { background: #218838; }
        #status {
            font-size: 14px;
            color: #4caf50;
            font-weight: bold;
            transition: opacity 0.5s;
            opacity: 0;
        }
    </style>
</head>
<body>

    <div id="auth-wrap">
        <h2>ðŸ”’ Private Shared Document</h2>
        <p>Enter password to view and edit</p>
        <input type="password" id="passInput" placeholder="Password...">
        <button onclick="checkPass()">Enter</button>
    </div>

    <div id="editor-wrap">
        <h1>Community Document</h1>
        <div class="controls">
            <button class="btn-download" onclick="downloadDoc()">Download as .txt</button>
            <span id="status">âœ” Saved</span>
        </div>
        <textarea id="editor" placeholder="Start typing here... everyone sees your changes in real-time."></textarea>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // --- CONFIGURATION START ---
      const firebaseConfig = {
        apiKey: "AIzaSyA37qLDa58E4DpWrktv2o5zIrKPd69OZXM",
        databaseURL: "https://gitdoc-e0149-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gitdoc-e0149",
      };
      const SITE_PASSWORD = "$WM";
      // --- CONFIGURATION END ---

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const docRef = ref(db, 'sharedContent');
      const editor = document.getElementById('editor');
      const status = document.getElementById('status');

      // Password Check Function
      window.checkPass = () => {
          const input = document.getElementById('passInput').value;
          if (input === SITE_PASSWORD) {
              document.getElementById('auth-wrap').style.display = 'none';
              document.getElementById('editor-wrap').style.display = 'block';
          } else {
              alert("Incorrect password.");
          }
      };

      // Download Function
      window.downloadDoc = () => {
          const text = editor.value;
          const blob = new Blob([text], { type: 'text/plain' });
          const anchor = document.createElement('a');
          anchor.download = 'community-doc-' + new Date().toLocaleDateString() + '.txt';
          anchor.href = window.URL.createObjectURL(blob);
          anchor.click();
      };

      // Sync from Database (Smooth Cursor Logic)
      onValue(docRef, (snapshot) => {
        const data = snapshot.val();
        if (data !== null) {
            if (document.activeElement !== editor) {
                // If we aren't typing, just update the box
                editor.value = data;
            } else if (data !== editor.value) {
                // If we ARE typing and someone else changed it, 
                // update while keeping our cursor position
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = data;
                editor.setSelectionRange(start, end);
            }
        }
      });

      // Save to Database on every keystroke
      editor.addEventListener('input', (e) => {
        set(docRef, e.target.value).then(() => {
            // Show "Saved" checkmark briefly
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 1000);
        });
      });
    </script>
</body>
</html>
